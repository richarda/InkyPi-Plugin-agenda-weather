<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div>
    <label class="form-label">Calendars:</label>
    <div id="calendarList"></div>
    <button type="button" id="addCalendarBtn" class="form-input collapsible" onclick="addCalendarInput('')">Add
        Calendar</button>
</div>

<div class="form-group">
    <div class="form-group">
        <label for="language" class="form-label">Language:</label>
        <select id="language" name="language" class="form-input">
            {% for code, name in locale_map.items() %}
            <option value="{{ code }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-group">
    <label class="form-label">Weather location:</label>
    <div class="form-group">
        <span>Latitude </span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span>Longitude </span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <button type="button" id="openMap" class="action-button compact">Select Location</button>
</div>

<div class="form-group">
    <div class="form-group nowrap">
        <label for="fontSize" class="form-label">Font Size:</label>
        <select id="fontSize" name="fontSize" class="form-input">
            <option value="x-small">Extra Small</option>
            <option value="smaller">Smaller</option>
            <option value="small">Small</option>
            <option value="normal">Normal</option>
            <option value="large">Large</option>
            <option value="larger">Larger</option>
            <option value="x-large">Extra Larger</option>
        </select>
    </div>
</div>

<div class="form-group">
    <div class="form-group nowrap">
        <label for="units" class="form-label">Temperature Units:</label>
        <select id="units" name="units" class="form-input">
            <option value="imperial">°F (Fahrenheit)</option>
            <option value="metric">°C (Celsius)</option>
            <option value="standard">K (Kelvin)</option>
        </select>
    </div>
</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">×</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div id="agendaWeatherMap" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>
    function addCalendarInput(url = '') {
        const calendarList = document.getElementById('calendarList');

        const wrapper = document.createElement('div');
        wrapper.classList.add('calendar-entry');
        wrapper.classList.add('form-group');

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.name = 'calendarURLs[]';
        urlInput.placeholder = 'Calendar URL';
        urlInput.required = true;
        urlInput.classList.add('form-input');
        urlInput.value = url;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.innerText = '✕';
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => wrapper.remove();

        wrapper.appendChild(urlInput);
        wrapper.appendChild(removeBtn);

        calendarList.appendChild(wrapper);
    }

    // populate form values from plugin settings
    document.addEventListener('DOMContentLoaded', () => {
        // defaults
        let language = "en";
        let calendars = [{ url: '' }];
        let fontSize = "normal";
        let latitude = "";
        let longitude = "";

        if (loadPluginSettings) {
            language = pluginSettings.language || "en";
            fontSize = pluginSettings.fontSize || "normal";
            latitude = pluginSettings.latitude != null && pluginSettings.latitude !== "" ? pluginSettings.latitude : "";
            longitude = pluginSettings.longitude != null && pluginSettings.longitude !== "" ? pluginSettings.longitude : "";

            if (pluginSettings["calendarURLs[]"]) {
                calendars = pluginSettings["calendarURLs[]"].map((url) => ({
                    url: url || ''
                }));
            }
        }

        // populate language dropdown
        document.getElementById('language').value = language;
        document.getElementById('fontSize').value = fontSize;
        document.getElementById('units').value = pluginSettings && pluginSettings.units ? pluginSettings.units : 'imperial';
        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;

        // populate calendars
        calendars.forEach(({ url }) => {
            addCalendarInput(url);
        });

        // Map picker for weather location (like weather plugin)
        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $mapModal = document.querySelector('#mapModal');
        const $closeMap = document.querySelector('#closeMap');

        let mapLat = latitude ? +latitude : 49.8728;
        let mapLon = longitude ? +longitude : 8.6512;
        let zoom = (latitude && longitude) ? 4.5 : 2.5;
        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal');
            setTimeout(() => {
                if (!map) {
                    map = L.map('agendaWeatherMap').setView([mapLat, mapLon], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([mapLat, mapLon], { draggable: true }).addTo(map);
                    map.on('click', (event) => {
                        marker.setLatLng(event.latlng);
                    });
                } else {
                    map.setView([mapLat, mapLon], zoom);
                    marker.setLatLng([mapLat, mapLon]);
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            mapLat = position.lat;
            mapLon = position.lng;
            $latitude.value = position.lat;
            $longitude.value = position.lng;
            closeModal('mapModal');
        });
    });
</script>